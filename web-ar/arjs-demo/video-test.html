<!DOCTYPE html>
<html>
<head>
    <title>AR.js è§†é¢‘å°ºå¯¸æµ‹è¯•</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
        }

        .video-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .controls button {
            background: #4CC3D9;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .controls button:hover {
            background: #3BA8C0;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .error {
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success {
            background: rgba(0,255,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .warning {
            background: rgba(255,255,0,0.8);
            color: black;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dimension-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            z-index: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-container">
            <video id="videoElement" autoplay muted playsinline></video>
            <div class="dimension-overlay" id="dimensionOverlay">
                ç­‰å¾…æ‘„åƒå¤´...
            </div>
        </div>

        <div class="video-info" id="videoInfo">
            <h3>ğŸ“¹ è§†é¢‘ä¿¡æ¯</h3>
            <div id="infoContent">æ­£åœ¨è·å–æ‘„åƒå¤´ä¿¡æ¯...</div>
        </div>

        <div class="status" id="status">
            çŠ¶æ€: åˆå§‹åŒ–ä¸­...
        </div>

        <div class="controls">
            <button onclick="startCamera()">ğŸ¥ å¯åŠ¨æ‘„åƒå¤´</button>
            <button onclick="stopCamera()">â¹ï¸ åœæ­¢æ‘„åƒå¤´</button>
            <button onclick="changeResolution()">ğŸ“ åˆ‡æ¢åˆ†è¾¨ç‡</button>
            <button onclick="showDebugInfo()">ğŸ” è°ƒè¯•ä¿¡æ¯</button>
            <button onclick="fixDimensions()">ğŸ”§ ä¿®å¤å°ºå¯¸</button>
        </div>
    </div>

    <script>
        let videoStream = null;
        let currentConstraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'environment'
            }
        };

        const resolutions = [
            { width: 640, height: 480, name: 'VGA' },
            { width: 1280, height: 720, name: 'HD' },
            { width: 1920, height: 1080, name: 'Full HD' },
            { width: 1280, height: 960, name: '4:3 HD' },
            { width: 854, height: 480, name: 'WVGA' }
        ];

        let currentResolutionIndex = 1;

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                updateStatus('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...');
                
                // åœæ­¢ç°æœ‰æµ
                if (videoStream) {
                    stopCamera();
                }

                // è·å–æ‘„åƒå¤´æƒé™
                videoStream = await navigator.mediaDevices.getUserMedia(currentConstraints);
                
                const video = document.getElementById('videoElement');
                video.srcObject = videoStream;
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                video.onloadedmetadata = function() {
                    updateVideoInfo();
                    updateStatus('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
                };

                video.onerror = function() {
                    updateStatus('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥', 'error');
                };

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                updateStatus('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const video = document.getElementById('videoElement');
            video.srcObject = null;
            
            updateStatus('æ‘„åƒå¤´å·²åœæ­¢');
            updateVideoInfo();
        }

        // åˆ‡æ¢åˆ†è¾¨ç‡
        async function changeResolution() {
            currentResolutionIndex = (currentResolutionIndex + 1) % resolutions.length;
            const resolution = resolutions[currentResolutionIndex];
            
            currentConstraints.video = {
                width: { ideal: resolution.width },
                height: { ideal: resolution.height },
                facingMode: 'environment'
            };

            updateStatus(`åˆ‡æ¢åˆ° ${resolution.name} (${resolution.width}x${resolution.height})`);
            
            if (videoStream) {
                await startCamera();
            }
        }

        // æ›´æ–°è§†é¢‘ä¿¡æ¯
        function updateVideoInfo() {
            const video = document.getElementById('videoElement');
            const infoContent = document.getElementById('infoContent');
            const overlay = document.getElementById('dimensionOverlay');

            if (!video.srcObject) {
                infoContent.innerHTML = '<div class="warning">æ‘„åƒå¤´æœªå¯åŠ¨</div>';
                overlay.textContent = 'æ‘„åƒå¤´æœªå¯åŠ¨';
                return;
            }

            const info = `
                <div><strong>å®é™…å°ºå¯¸:</strong> ${video.videoWidth} x ${video.videoHeight}</div>
                <div><strong>æ˜¾ç¤ºå°ºå¯¸:</strong> ${video.offsetWidth} x ${video.offsetHeight}</div>
                <div><strong>è®¾å¤‡åƒç´ æ¯”:</strong> ${window.devicePixelRatio}</div>
                <div><strong>å±å¹•å°ºå¯¸:</strong> ${window.innerWidth} x ${window.innerHeight}</div>
                <div><strong>è§†é¢‘å°±ç»ªçŠ¶æ€:</strong> ${video.readyState}</div>
                <div><strong>å½“å‰åˆ†è¾¨ç‡:</strong> ${resolutions[currentResolutionIndex].name}</div>
            `;

            infoContent.innerHTML = info;

            // æ›´æ–°è¦†ç›–å±‚
            overlay.textContent = `${video.videoWidth} x ${video.videoHeight}`;

            // æ£€æŸ¥å°ºå¯¸æ˜¯å¦æ­£å¸¸
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                infoContent.innerHTML += '<div class="error">âš ï¸ è§†é¢‘å°ºå¯¸å¼‚å¸¸</div>';
            } else {
                infoContent.innerHTML += '<div class="success">âœ… è§†é¢‘å°ºå¯¸æ­£å¸¸</div>';
            }
        }

        // ä¿®å¤è§†é¢‘å°ºå¯¸
        function fixDimensions() {
            const video = document.getElementById('videoElement');
            if (!video.srcObject) {
                alert('è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´');
                return;
            }

            // å°è¯•ä¿®å¤è§†é¢‘å°ºå¯¸
            const tracks = video.srcObject.getTracks();
            tracks.forEach(track => {
                if (track.kind === 'video') {
                    const capabilities = track.getCapabilities();
                    console.log('æ‘„åƒå¤´èƒ½åŠ›:', capabilities);
                    
                    if (capabilities.width && capabilities.height) {
                        const settings = {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        };
                        
                        track.applyConstraints(settings)
                            .then(() => {
                                console.log('è§†é¢‘çº¦æŸåº”ç”¨æˆåŠŸ');
                                updateVideoInfo();
                            })
                            .catch(error => {
                                console.error('è§†é¢‘çº¦æŸåº”ç”¨å¤±è´¥:', error);
                            });
                    }
                }
            });
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const video = document.getElementById('videoElement');
            const info = `
è®¾å¤‡ä¿¡æ¯:
- User Agent: ${navigator.userAgent}
- å¹³å°: ${navigator.platform}
- è¯­è¨€: ${navigator.language}
- åœ¨çº¿çŠ¶æ€: ${navigator.onLine}

è§†é¢‘ä¿¡æ¯:
- è§†é¢‘å…ƒç´ : ${video ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}
- è§†é¢‘æµ: ${video.srcObject ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}
- å®é™…å°ºå¯¸: ${video.videoWidth} x ${video.videoHeight}
- æ˜¾ç¤ºå°ºå¯¸: ${video.offsetWidth} x ${video.offsetHeight}
- å°±ç»ªçŠ¶æ€: ${video.readyState}
- æ’­æ”¾çŠ¶æ€: ${!video.paused ? 'æ’­æ”¾ä¸­' : 'æš‚åœ'}

æ‘„åƒå¤´çº¦æŸ:
${JSON.stringify(currentConstraints, null, 2)}
            `;

            console.log(info);
            alert(info);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'çŠ¶æ€: ' + message;
            
            // ç§»é™¤ä¹‹å‰çš„æ ·å¼ç±»
            statusEl.className = 'status';
            
            // æ·»åŠ æ–°çš„æ ·å¼ç±»
            if (type === 'error') {
                statusEl.style.background = 'rgba(255,0,0,0.8)';
            } else if (type === 'success') {
                statusEl.style.background = 'rgba(0,255,0,0.8)';
            } else {
                statusEl.style.background = 'rgba(0,0,0,0.8)';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¯åŠ¨æ‘„åƒå¤´
        window.addEventListener('load', function() {
            updateStatus('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¯åŠ¨æ‘„åƒå¤´');
            
            // æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API', 'error');
                return;
            }

            // å»¶è¿Ÿå¯åŠ¨æ‘„åƒå¤´
            setTimeout(() => {
                startCamera();
            }, 1000);
        });

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function() {
            updateVideoInfo();
        });

        // ç›‘å¬è§†é¢‘äº‹ä»¶
        document.getElementById('videoElement').addEventListener('loadedmetadata', function() {
            updateVideoInfo();
        });

        // å®šæœŸæ›´æ–°è§†é¢‘ä¿¡æ¯
        setInterval(updateVideoInfo, 2000);
    </script>
</body>
</html>
