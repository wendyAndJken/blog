<!DOCTYPE html>
<html>
<head>
    <title>AR.js Demo - 移动端优化版</title>l
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        /* CSS变量定义 - 支持主题切换 */
        :root {
            --primary-color: #4CC3D9;
            --primary-hover: #3BA8C0;
            --secondary-color: #FF6B6B;
            --success-color: #4ECDC4;
            --warning-color: #FFEAA7;
            --error-color: #FF5252;
            
            --bg-primary: #000000;
            --bg-secondary: rgba(0,0,0,0.8);
            --bg-tertiary: rgba(0,0,0,0.95);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.8);
            
            --border-radius-sm: 8px;
            --border-radius-md: 15px;
            --border-radius-lg: 20px;
            --border-radius-xl: 25px;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.2);
            
            --blur-sm: blur(8px);
            --blur-md: blur(12px);
            --blur-lg: blur(16px);
            
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* 暗黑主题变量 */
        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: rgba(10,10,10,0.9);
            --bg-tertiary: rgba(10,10,10,0.98);
        }

        /* 亮色主题变量 */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: rgba(255,255,255,0.9);
            --bg-tertiary: rgba(255,255,255,0.98);
            --text-primary: #000000;
            --text-secondary: rgba(0,0,0,0.8);
        }

        /* 基础样式重置 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        *::before,
        *::after {
            box-sizing: border-box;
        }

        /* 根元素样式 */
        html {
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        /* 主体样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* 加载界面 */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            z-index: 1000;
            text-align: center;
            min-width: 240px;
            backdrop-filter: var(--blur-lg);
            -webkit-backdrop-filter: var(--blur-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .loading .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading .spinner::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid transparent;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 说明界面 */
        .instructions {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 1.5rem;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            z-index: 1000;
            backdrop-filter: var(--blur-md);
            -webkit-backdrop-filter: var(--blur-md);
            line-height: 1.6;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all var(--transition-normal);
        }

        .instructions h3 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instructions ol {
            margin: 0;
            padding-left: 1.25rem;
            list-style: none;
            counter-reset: step-counter;
        }

        .instructions li {
            margin-bottom: 0.5rem;
            counter-increment: step-counter;
            position: relative;
            padding-left: 0.5rem;
        }

        .instructions li::before {
            content: counter(step-counter);
            position: absolute;
            left: -1.5rem;
            top: 0;
            background: var(--primary-color);
            color: white;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* 错误界面 */
        .error {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            background: rgba(255,82,82,0.95);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            z-index: 1000;
            display: none;
            backdrop-filter: var(--blur-md);
            -webkit-backdrop-filter: var(--blur-md);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .error strong {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        /* CDN状态 */
        .cdn-status {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            z-index: 1000;
            max-width: 200px;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all var(--transition-fast);
        }

        /* 权限提示 */
        .permission-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 2.5rem;
            border-radius: var(--border-radius-lg);
            z-index: 2000;
            text-align: center;
            max-width: 320px;
            backdrop-filter: var(--blur-lg);
            -webkit-backdrop-filter: var(--blur-lg);
            display: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .permission-prompt h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .permission-prompt p {
            margin: 0 0 1.5rem 0;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .permission-prompt button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: var(--border-radius-xl);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .permission-prompt button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left var(--transition-slow);
        }

        .permission-prompt button:hover::before {
            left: 100%;
        }

        .permission-prompt button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .permission-prompt button:active {
            transform: translateY(0);
        }

        /* 控制按钮 */
        .controls {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            padding: 0.75rem;
            z-index: 1000;
            display: none;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .controls button {
            background: rgba(255,255,255,0.15);
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-sm);
            margin: 0.125rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        .controls button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .controls button:active {
            transform: translateY(0);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }

            .instructions {
                font-size: 0.8rem;
                padding: 1.25rem;
                bottom: 1rem;
                left: 1rem;
                right: 1rem;
            }

            .instructions h3 {
                font-size: 0.9rem;
            }

            .cdn-status {
                font-size: 0.7rem;
                padding: 0.625rem 0.875rem;
                max-width: 160px;
            }

            .loading {
                padding: 1.5rem;
                min-width: 200px;
            }

            .permission-prompt {
                padding: 2rem;
                max-width: 280px;
                margin: 0 1rem;
            }

            .controls {
                top: 1rem;
                left: 1rem;
                padding: 0.5rem;
            }

            .controls button {
                padding: 0.375rem 0.625rem;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            html {
                font-size: 13px;
            }

            .instructions {
                font-size: 0.75rem;
                padding: 1rem;
            }

            .permission-prompt {
                padding: 1.5rem;
                max-width: 260px;
            }
        }

        /* 横屏优化 */
        @media (orientation: landscape) and (max-height: 500px) {
            .instructions {
                bottom: 0.75rem;
                padding: 0.75rem;
                font-size: 0.7rem;
            }

            .instructions h3 {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }

            .instructions ol {
                padding-left: 1rem;
            }

            .instructions li {
                margin-bottom: 0.25rem;
            }

            .permission-prompt {
                padding: 1.5rem;
                max-width: 300px;
            }
        }

        /* 高分辨率屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .loading .spinner {
                border-width: 2px;
            }

            .instructions li::before {
                width: 1.5rem;
                height: 1.5rem;
                font-size: 0.8rem;
            }
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loading,
        .instructions,
        .permission-prompt {
            animation: fadeIn 0.5s ease-out;
        }

        .cdn-status {
            animation: slideIn 0.3s ease-out;
        }

        /* 无障碍支持 */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* 焦点样式 */
        button:focus,
        .permission-prompt button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* 选择器优化 */
        @supports (selector(:has(*))) {
            .instructions:has(h3) {
                border-left: 3px solid var(--primary-color);
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>正在加载AR场景...</div>
    </div>
    
    <div class="error" id="error">
        <strong>⚠️ 加载失败</strong>
        <p>请检查网络连接或刷新页面重试</p>
    </div>
    
    <div class="cdn-status" id="cdn-status">
        <span>🔄 正在加载CDN资源...</span>
    </div>
    
    <div class="instructions">
        <h3>📱 移动端AR体验</h3>
        <ol>
            <li>点击"开始AR"按钮</li>
            <li>允许摄像头权限</li>
            <li>将摄像头对准Marker图案</li>
            <li>点击红色球体进行交互</li>
        </ol>
    </div>
    
    <div class="permission-prompt" id="permission-prompt">
        <h3>🎥 摄像头权限</h3>
        <p>AR体验需要访问您的摄像头来识别Marker图案</p>
        <button onclick="startAR()">
            <span>🚀 开始AR体验</span>
        </button>
    </div>
    
    <div class="controls" id="controls">
        <button onclick="toggleInstructions()" title="显示/隐藏说明">
            <span>📖 说明</span>
        </button>
        <button onclick="resetScene()" title="重置AR场景">
            <span>🔄 重置</span>
        </button>
        <button onclick="debugVideo()" title="调试视频尺寸">
            <span>🎥 调试</span>
        </button>
    </div>

    <script>
        // 设备检测
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        
        // CDN源列表 - 移动端优化
        const CDN_SOURCES = [
        {
                name: 'unpkg',
                aframe: 'https://unpkg.com/aframe@1.7.1/dist/aframe-master.js',
                arjs: 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'
            },
            {
                name: 'unpkg',
                aframe: 'https://unpkg.com/aframe@1.7.1/dist/aframe-master.min.js',
                arjs: 'https://unpkg.com/aframe-ar@1.7.1/dist/aframe-ar-nft.min.js'
            },
            {
                name: 'cdnjs',
                aframe: 'https://cdnjs.cloudflare.com/ajax/libs/aframe/1.7.1/aframe.min.js',
                arjs: 'https://cdnjs.cloudflare.com/ajax/libs/aframe-ar/1.7.1/aframe-ar-nft.min.js'
            }
        ];

        let currentCDN = 0;
        let aframeLoaded = false;
        let arjsLoaded = false;
        let arScene = null;
        let instructionsVisible = true;

        // 更新状态显示
        function updateStatus(message) {
            const statusEl = document.getElementById('cdn-status');
            if (statusEl) {
                const span = statusEl.querySelector('span');
                if (span) {
                    span.textContent = message;
                } else {
                    statusEl.innerHTML = `<span>${message}</span>`;
                }
            }
        }

        // 加载脚本
        function loadScript(src, onSuccess, onError) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    onSuccess && onSuccess();
                    resolve();
                };
                script.onerror = () => {
                    onError && onError();
                    reject();
                };
                document.head.appendChild(script);
            });
        }

        // 检测摄像头权限
        async function checkCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.warn('摄像头权限检查失败:', error);
                return false;
            }
        }

        // 开始AR体验
        async function startAR() {
            document.getElementById('permission-prompt').style.display = 'none';
            
            try {
                const hasPermission = await checkCameraPermission();
                if (!hasPermission) {
                    alert('需要摄像头权限才能使用AR功能');
                    return;
                }
                
                initARScene();
            } catch (error) {
                console.error('启动AR失败:', error);
                alert('启动AR失败，请重试');
            }
        }

        // 尝试加载CDN资源
        async function tryLoadCDN() {
            for (let i = 0; i < CDN_SOURCES.length; i++) {
                const cdn = CDN_SOURCES[i];
                currentCDN = i;
                
                try {
                    updateStatus(`加载 ${cdn.name}...`);
                    
                    // 加载A-Frame
                    if (!aframeLoaded) {
                        await loadScript(cdn.aframe, 
                            () => { 
                                aframeLoaded = true; 
                                updateStatus(`${cdn.name}: A-Frame ✓`); 
                            },
                            () => { throw new Error('A-Frame 加载失败'); }
                        );
                    }
                    
                    // 加载AR.js
                    if (!arjsLoaded) {
                        await loadScript(cdn.arjs,
                            () => { 
                                arjsLoaded = true; 
                                updateStatus(`${cdn.name}: AR.js ✓`); 
                            },
                            () => { throw new Error('AR.js 加载失败'); }
                        );
                    }
                    
                    // 两个都加载成功
                    updateStatus(`${cdn.name} 加载完成`);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('permission-prompt').style.display = 'block';
                    return;
                    
                } catch (error) {
                    console.warn(`${cdn.name} 加载失败:`, error);
                    continue;
                }
            }
            
            // 所有CDN都失败了
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            updateStatus('加载失败');
        }

        // 初始化AR场景
        function initARScene() {
            if (typeof AFRAME === 'undefined') {
                setTimeout(initARScene, 100);
                return;
            }
            
            // 获取设备屏幕尺寸
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // 计算合适的视频尺寸
            const aspectRatio = screenWidth / screenHeight;
            let videoWidth, videoHeight;
            
            if (aspectRatio > 1) {
                // 横屏
                videoWidth = Math.min(1280, screenWidth);
                videoHeight = Math.round(videoWidth / aspectRatio);
            } else {
                // 竖屏
                videoHeight = Math.min(960, screenHeight);
                videoWidth = Math.round(videoHeight * aspectRatio);
            }
            
            // 确保尺寸是偶数（某些设备要求）
            videoWidth = videoWidth % 2 === 0 ? videoWidth : videoWidth - 1;
            videoHeight = videoHeight % 2 === 0 ? videoHeight : videoHeight - 1;
            
            console.log(`设备尺寸: ${screenWidth}x${screenHeight}`);
            console.log(`视频尺寸: ${videoWidth}x${videoHeight}`);
            
            // 创建AR场景 - 动态响应式配置
            const scene = document.createElement('a-scene');
            scene.setAttribute('embedded', '');
            scene.setAttribute('arjs', `
                sourceType: webcam; 
                debugUIEnabled: false;
                detectionMode: mono_and_matrix;
                matrixCodeType: 3x3;
                sourceWidth: ${videoWidth};
                sourceHeight: ${videoHeight};
                displayWidth: ${videoWidth};
                displayHeight: ${videoHeight};
                canvasWidth: ${videoWidth};
                canvasHeight: ${videoHeight};
                patternRatio: 0.75;
                trackingMethod: best;
                maxDetectionRate: 60;
                faceingMode: environment;
                cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat;
                videoTexture: true;
                maxARVideoSize: 1280;
                cameraMinDistance: 0.1;
                cameraMaxDistance: 1000;
                cameraFacingMode: environment;
                cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat;
            `);
            
            // 创建Marker
            const marker = document.createElement('a-marker');
            marker.setAttribute('preset', 'hiro');
            marker.setAttribute('emitevents', 'true');
            marker.setAttribute('cursor', 'rayOrigin: mouse');
            
            // 创建3D立方体
            const box = document.createElement('a-box');
            box.setAttribute('position', '0 0.5 0');
            box.setAttribute('material', 'color: #4CC3D9; metalness: 0.5; roughness: 0.2');
            box.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 3000; easing: linear; loop: true');
            box.setAttribute('shadow', 'cast: true; receive: false');
            
            // 创建可交互球体
            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('position', '0 0.5 1');
            sphere.setAttribute('radius', '0.25');
            sphere.setAttribute('material', 'color: #FF6B6B; metalness: 0.3; roughness: 0.4');
            sphere.setAttribute('class', 'clickable');
            sphere.setAttribute('animation', 'property: scale; to: 1.3 1.3 1.3; dur: 1500; easing: easeInOutQuad; direction: alternate; loop: true');
            sphere.setAttribute('shadow', 'cast: true; receive: false');
            
            // 添加球体点击效果
            sphere.setAttribute('animation__click', 'property: scale; to: 0.8 0.8 0.8; dur: 200; easing: easeOutQuad; startEvents: click');
            sphere.setAttribute('animation__clickback', 'property: scale; to: 1 1 1; dur: 200; easing: easeOutQuad; startEvents: animationcomplete__click');
            
            // 创建相机
            const camera = document.createElement('a-entity');
            camera.setAttribute('camera', '');
            camera.setAttribute('look-controls', 'enabled: false');
            camera.setAttribute('cursor', 'rayOrigin: mouse');
            
            // 添加光源
            const light = document.createElement('a-light');
            light.setAttribute('type', 'ambient');
            light.setAttribute('color', '#ffffff');
            light.setAttribute('intensity', '0.6');
            
            const directionalLight = document.createElement('a-light');
            directionalLight.setAttribute('type', 'directional');
            directionalLight.setAttribute('color', '#ffffff');
            directionalLight.setAttribute('intensity', '0.8');
            directionalLight.setAttribute('position', '0 5 5');
            
            // 组装场景
            marker.appendChild(box);
            marker.appendChild(sphere);
            scene.appendChild(marker);
            scene.appendChild(camera);
            scene.appendChild(light);
            scene.appendChild(directionalLight);
            
            // 添加到页面
            document.body.appendChild(scene);
            arScene = scene;
            
            // 显示控制按钮
            document.getElementById('controls').style.display = 'block';
            
            // 添加触摸和点击交互
            setupInteractions(scene);
            
            // 添加Marker检测事件
            marker.addEventListener('markerFound', function() {
                console.log('Marker detected!');
                updateStatus('Marker已检测到');
            });
            
            marker.addEventListener('markerLost', function() {
                console.log('Marker lost!');
                updateStatus('Marker丢失');
            });
            
            // 监控视频尺寸和性能
            scene.addEventListener('loaded', function() {
                console.log('AR场景加载完成');
                
                // 检查视频元素
                setTimeout(() => {
                    const videoElement = scene.querySelector('video');
                    if (videoElement) {
                        console.log('视频元素尺寸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                        console.log('视频元素显示尺寸:', videoElement.offsetWidth, 'x', videoElement.offsetHeight);
                        
                        // 如果视频尺寸异常，尝试修复
                        if (videoElement.videoWidth === 0 || videoElement.videoHeight === 0) {
                            console.warn('视频尺寸异常，尝试重新初始化...');
                            fixVideoDimensions(scene, videoWidth, videoHeight);
                        }
                    }
                }, 1000);
            });
        }

        // 设置交互事件
        function setupInteractions(scene) {
            // 触摸事件处理
            let touchStartTime = 0;
            let touchStartPosition = { x: 0, y: 0 };
            
            scene.addEventListener('touchstart', function(event) {
                touchStartTime = Date.now();
                touchStartPosition = {
                    x: event.touches[0].clientX,
                    y: event.touches[0].clientY
                };
            });
            
            scene.addEventListener('touchend', function(event) {
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;
                const touchEndPosition = {
                    x: event.changedTouches[0].clientX,
                    y: event.changedTouches[0].clientY
                };
                
                const distance = Math.sqrt(
                    Math.pow(touchEndPosition.x - touchStartPosition.x, 2) +
                    Math.pow(touchEndPosition.y - touchStartPosition.y, 2)
                );
                
                // 短触摸且移动距离小，认为是点击
                if (touchDuration < 300 && distance < 10) {
                    handleClick(event);
                }
            });
            
            // 鼠标点击事件
            scene.addEventListener('click', handleClick);
        }

        // 处理点击事件
        function handleClick(event) {
            const intersectedElement = event.detail.intersectedEl;
            if (intersectedElement && intersectedElement.classList.contains('clickable')) {
                // 触发点击动画
                intersectedElement.emit('click');
                
                // 显示反馈
                showFeedback('🎉 交互成功！');
                
                // 改变颜色
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                intersectedElement.setAttribute('material', 'color', randomColor);
            }
        }

        // 显示反馈信息
        function showFeedback(message) {
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-tertiary);
                color: var(--text-primary);
                padding: 1rem 1.5rem;
                border-radius: var(--border-radius-xl);
                font-size: 1rem;
                font-weight: 600;
                z-index: 2000;
                backdrop-filter: var(--blur-lg);
                -webkit-backdrop-filter: var(--blur-lg);
                box-shadow: var(--shadow-lg);
                border: 1px solid rgba(255,255,255,0.1);
                animation: fadeIn 0.3s ease-out;
                text-align: center;
                min-width: 200px;
            `;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            // 添加淡出动画
            setTimeout(() => {
                feedback.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => {
                    feedback.remove();
                }, 300);
            }, 1700);
        }

        // 切换说明显示
        function toggleInstructions() {
            const instructions = document.querySelector('.instructions');
            instructionsVisible = !instructionsVisible;
            instructions.style.display = instructionsVisible ? 'block' : 'none';
        }

        // 修复视频尺寸
        function fixVideoDimensions(scene, targetWidth, targetHeight) {
            const videoElement = scene.querySelector('video');
            if (!videoElement) return;
            
            // 尝试设置视频尺寸
            videoElement.style.width = targetWidth + 'px';
            videoElement.style.height = targetHeight + 'px';
            
            // 强制重新加载视频流
            if (videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => {
                    if (track.kind === 'video') {
                        const capabilities = track.getCapabilities();
                        if (capabilities.width && capabilities.height) {
                            const settings = {
                                width: { ideal: targetWidth },
                                height: { ideal: targetHeight }
                            };
                            track.applyConstraints(settings).catch(console.warn);
                        }
                    }
                });
            }
            
            console.log('视频尺寸修复完成');
        }
        
        // 视频调试功能
        function debugVideo() {
            if (!arScene) {
                alert('AR场景未初始化');
                return;
            }
            
            const videoElement = arScene.querySelector('video');
            if (!videoElement) {
                alert('未找到视频元素');
                return;
            }
            
            const info = `
视频调试信息:
- 视频实际尺寸: ${videoElement.videoWidth} x ${videoElement.videoHeight}
- 视频显示尺寸: ${videoElement.offsetWidth} x ${videoElement.offsetHeight}
- 视频样式尺寸: ${videoElement.style.width} x ${videoElement.style.height}
- 设备屏幕尺寸: ${window.innerWidth} x ${window.innerHeight}
- 设备像素比: ${window.devicePixelRatio}
- 视频就绪状态: ${videoElement.readyState}
- 视频播放状态: ${!videoElement.paused ? '播放中' : '暂停'}
            `;
            
            console.log(info);
            alert(info);
        }
        
        // 重置场景
        function resetScene() {
            if (arScene) {
                arScene.remove();
                arScene = null;
            }
            initARScene();
        }

        // 页面加载完成后开始加载CDN
        window.addEventListener('load', tryLoadCDN);
        
        // 防止页面滚动
        document.addEventListener('touchmove', function(event) {
            event.preventDefault();
        }, { passive: false });
        
        // 防止双击缩放
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
