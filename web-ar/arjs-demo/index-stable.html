<!DOCTYPE html>
<html>
<head>
    <title>AR.js Demo - 稳定版本</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
        }
        .error {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        .cdn-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div class="loading" id="loading">
        正在加载AR场景...
    </div>
    
    <div class="error" id="error">
        <strong>加载失败</strong><br>
        请检查网络连接或使用备用链接
    </div>
    
    <div class="cdn-status" id="cdn-status">
        正在加载CDN资源...
    </div>
    
    <div class="instructions">
        <strong>使用说明：</strong><br>
        1. 允许摄像头权限<br>
        2. 将摄像头对准Marker图案<br>
        3. 等待3D模型出现<br>
        4. 移动设备查看不同角度
    </div>

    <script>
        // CDN源列表
        const CDN_SOURCES = [
            {
                name: 'unpkg',
                aframe: 'https://unpkg.com/aframe@1.7.1/dist/aframe-master.js',
                arjs: 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'
            },
            {
                name: 'jsdelivr',
                aframe: 'https://cdn.jsdelivr.net/npm/aframe@1.7.1/dist/aframe-master.js',
                arjs: 'https://cdn.jsdelivr.net/npm/aframe-ar@1.7.1/dist/aframe-ar-nft.js'
            },
            {
                name: 'cdnjs',
                aframe: 'https://cdnjs.cloudflare.com/ajax/libs/aframe/1.7.1/aframe.min.js',
                arjs: 'https://cdnjs.cloudflare.com/ajax/libs/aframe-ar/1.7.1/aframe-ar-nft.js'
            }
        ];

        let currentCDN = 0;
        let aframeLoaded = false;
        let arjsLoaded = false;

        // 更新状态显示
        function updateStatus(message) {
            document.getElementById('cdn-status').textContent = message;
        }

        // 加载脚本
        function loadScript(src, onSuccess, onError) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    onSuccess && onSuccess();
                    resolve();
                };
                script.onerror = () => {
                    onError && onError();
                    reject();
                };
                document.head.appendChild(script);
            });
        }

        // 尝试加载CDN资源
        async function tryLoadCDN() {
            for (let i = 0; i < CDN_SOURCES.length; i++) {
                const cdn = CDN_SOURCES[i];
                currentCDN = i;
                
                try {
                    updateStatus(`尝试加载 ${cdn.name} CDN...`);
                    
                    // 加载A-Frame
                    if (!aframeLoaded) {
                        await loadScript(cdn.aframe, 
                            () => { aframeLoaded = true; updateStatus(`${cdn.name}: A-Frame 加载成功`); },
                            () => { throw new Error('A-Frame 加载失败'); }
                        );
                    }
                    
                    // 加载AR.js
                    if (!arjsLoaded) {
                        await loadScript(cdn.arjs,
                            () => { arjsLoaded = true; updateStatus(`${cdn.name}: AR.js 加载成功`); },
                            () => { throw new Error('AR.js 加载失败'); }
                        );
                    }
                    
                    // 两个都加载成功
                    updateStatus(`${cdn.name} CDN 加载完成`);
                    initARScene();
                    return;
                    
                } catch (error) {
                    console.warn(`${cdn.name} CDN 加载失败:`, error);
                    continue;
                }
            }
            
            // 所有CDN都失败了
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            updateStatus('所有CDN加载失败');
        }

        // 初始化AR场景
        function initARScene() {
            if (typeof AFRAME === 'undefined') {
                setTimeout(initARScene, 100);
                return;
            }
            
            // 创建AR场景
            const scene = document.createElement('a-scene');
            scene.setAttribute('embedded', '');
            scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false;');
            
            // 创建Marker
            const marker = document.createElement('a-marker');
            marker.setAttribute('preset', 'hiro');
            
            // 创建3D立方体
            const box = document.createElement('a-box');
            box.setAttribute('position', '0 0.5 0');
            box.setAttribute('material', 'color: #4CC3D9;');
            box.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 2000; easing: linear; loop: true');
            
            // 创建文字标签
            const text = document.createElement('a-text');
            text.setAttribute('value', 'AR.js Demo');
            text.setAttribute('position', '0 1.5 0');
            text.setAttribute('align', 'center');
            text.setAttribute('color', '#FFFFFF');
            text.setAttribute('font', 'kelsonsans');
            
            // 创建可点击球体
            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('position', '0 0.5 1');
            sphere.setAttribute('radius', '0.2');
            sphere.setAttribute('color', '#FF6B6B');
            sphere.setAttribute('class', 'clickable');
            sphere.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dur: 1000; easing: easeInOutQuad; direction: alternate; loop: true');
            
            // 创建相机
            const camera = document.createElement('a-entity');
            camera.setAttribute('camera', '');
            
            // 组装场景
            marker.appendChild(box);
            marker.appendChild(text);
            marker.appendChild(sphere);
            scene.appendChild(marker);
            scene.appendChild(camera);
            
            // 添加到页面
            document.body.appendChild(scene);
            
            // 隐藏加载提示
            document.getElementById('loading').style.display = 'none';
            
            // 添加点击交互
            document.addEventListener('click', function(event) {
                const intersectedElement = event.detail.intersectedEl;
                if (intersectedElement && intersectedElement.classList.contains('clickable')) {
                    intersectedElement.setAttribute('animation', {
                        property: 'rotation',
                        to: '0 360 0',
                        dur: 1000,
                        easing: 'easeInOutQuad'
                    });
                    alert('你点击了AR物体！');
                }
            });
        }

        // 页面加载完成后开始加载CDN
        window.addEventListener('load', tryLoadCDN);
    </script>
</body>
</html>
